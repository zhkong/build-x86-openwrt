name: X86 OpenWRT Build

on:
  # 每天 UTC 时间凌晨 2 点检查是否有新 release
  schedule:
    - cron: '0 2 * * *'
  # 允许手动触发
  workflow_dispatch:
    inputs:
      force_tag:
        description: '强制使用指定 tag (可选，留空则使用最新 release)'
        required: false
        type: string
  push:
  watch:
    types: started

jobs:
  check-release:
    runs-on: ubuntu-latest
    outputs:
      latest_tag: ${{ steps.check.outputs.latest_tag }}
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
    - name: Checkout
      uses: actions/checkout@main
      with:
        fetch-depth: 1
    - name: Check for new OpenWrt release
      id: check
      run: |
        # 获取最新的 OpenWrt release tag
        if [ -n "${{ github.event.inputs.force_tag }}" ]; then
          LATEST_TAG="${{ github.event.inputs.force_tag }}"
        else
          LATEST_TAG=$(curl -s https://api.github.com/repos/openwrt/openwrt/releases/latest | jq -r .tag_name)
        fi
        echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
        
        # 尝试获取上次构建记录的 tag
        LAST_TAG=""
        if [ -f ".last_built_tag" ]; then
          LAST_TAG=$(cat .last_built_tag)
        fi
        
        echo "Latest OpenWrt release: ${LATEST_TAG}"
        echo "Last built tag: ${LAST_TAG:-none}"
        
        # 判断是否需要构建
        SHOULD_BUILD="false"
        # 如果是手动触发或者有强制 tag，总是构建
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ -n "${{ github.event.inputs.force_tag }}" ]; then
          SHOULD_BUILD="true"
          echo "Manual trigger or force tag detected, will build"
        # 如果是 push 或 watch 事件，总是构建
        elif [ "${{ github.event_name }}" = "push" ] || [ "${{ github.event_name }}" = "watch" ]; then
          SHOULD_BUILD="true"
          echo "Push or watch event, will build"
        # 如果是定时任务，检查是否有新 tag
        elif [ "${{ github.event_name }}" = "schedule" ]; then
          if [ "${LATEST_TAG}" != "${LAST_TAG}" ]; then
            SHOULD_BUILD="true"
            echo "New release detected (${LAST_TAG} -> ${LATEST_TAG}), will build"
          else
            SHOULD_BUILD="false"
            echo "No new release, skipping build"
          fi
        else
          SHOULD_BUILD="true"
          echo "Unknown event type, will build"
        fi
        
        echo "should_build=${SHOULD_BUILD}" >> $GITHUB_OUTPUT

  build:
    needs: check-release
    runs-on: ubuntu-24.04
    if: |
      (github.event.repository.owner.id == github.event.sender.id || github.event_name == 'schedule') &&
      needs.check-release.outputs.should_build == 'true'

    steps:
    - name: Show system
      run: |
        echo -e "Total CPU cores\t: $(nproc)"
        cat /proc/cpuinfo | grep 'model name'
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 1024
        temp-reserve-mb: 512
        root-reserve-mb: 4608
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
    - name: Checkout
      uses: actions/checkout@main
    - name: Set OpenWrt tag
      run: |
        echo "OPENWRT_TAG=${{ needs.check-release.outputs.latest_tag }}" >> $GITHUB_ENV
        echo "Building with OpenWrt tag: ${{ needs.check-release.outputs.latest_tag }}"
    - name: Init build dependencies
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo /bin/bash -c "$(curl -sL https://git.io/vokNn)"
        sudo -E apt-fast -y -qq install asciidoc bash bcc bin86 binutils bison bzip2 clang-15 llvm-15 clang llvm file flex g++ g++-multilib gawk gcc gcc-multilib gettext git gzip help2man intltool libboost-dev libelf-dev libncurses-dev libncurses5-dev libssl-dev libthread-queue-any-perl libusb-dev libxml-parser-perl make patch perl-modules python3-dev python3-pip python3-pyelftools python3-setuptools rsync sharutils swig time unzip util-linux wget xsltproc zlib1g-dev zip zstd
        sudo -E apt-fast -y -qq install dos2unix dwarves quilt npm jq
        sudo -E npm install -g pnpm
        pip3 install --user -U pylibfdt --break-system-packages
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo -E git config --global user.name 'GitHub Actions' && git config --global user.email 'noreply@github.com'
        sudo -E git config --global core.abbrev auto
        df -h
    - name: prepare
      env:
        OPENWRT_TAG: ${{ needs.check-release.outputs.latest_tag }}
      run: |
        bash ./scripts/prepare.sh
    - name: Set tag_name for release
      run: |
        echo "tag_name=${{ needs.check-release.outputs.latest_tag }}" >>$GITHUB_ENV
    - name: Make Download
      run: |
        cd openwrt
        make download -j50
    - name: Make Defconfig
      run: |
        cd openwrt
        make defconfig
    - name: Compile Openwrt
      id: compileopenwrt
      continue-on-error: true
      run: |
        cd openwrt
        #echo | make kernel_oldconfig -j$(($(nproc) + 1)) 
        IGNORE_ERRORS=1 make -j$(($(nproc) + 1))
        echo $?
    - name: If Error
      if: steps.compileopenwrt.outcome == 'failure'
      run: |
        cat openwrt/.config
        echo '================================================================'
        cd openwrt && make -j1 V=s
    - name: Print Disk Space After
      run: df -h
    - name: Organize files
      id: organize
      run: |
        rm -rf ./artifact/
        mkdir -p ./artifact/
        mv openwrt/bin/targets/x86/64/openwrt-*gz ./artifact/
        mv openwrt/bin/targets/x86/64/config.buildinfo ./artifact/
        cd ./artifact/
        ls -Ahl
    - name: Upload artifact
      uses: actions/upload-artifact@main
      with:
        name: OpenWRT_${{ env.tag_name }}
        path: ./artifact/

    - name: Save built tag
      run: |
        echo "${{ needs.check-release.outputs.latest_tag }}" > .last_built_tag
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git config pull.rebase false
        git pull origin ${{ github.ref_name }} || true
        git add .last_built_tag
        # 只在有变化时提交
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: Update last built tag to ${{ needs.check-release.outputs.latest_tag }}"
          git push origin ${{ github.ref_name }} || echo "Failed to push tag file, but continuing..."
        fi
    - name: Create release
      id: create_release
      uses: ncipollo/release-action@v1.14.0
      with:
        name: ${{ env.tag_name }}
        allowUpdates: true
        tag: ${{ env.tag_name }}
        replacesArtifacts: true
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ./artifact/*
