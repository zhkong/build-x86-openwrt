name: X86 OpenWRT Build (ImageBuilder)

on:
  # 每天 UTC 时间凌晨 2 点检查是否有新 release
  schedule:
    - cron: '0 2 * * *'
  # 允许手动触发
  workflow_dispatch:
    inputs:
      force_tag:
        description: '强制使用指定 tag (可选，留空则使用最新 release)'
        required: false
        type: string
  push:
  watch:
    types: started

jobs:
  check-release:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      latest_tag: ${{ steps.check.outputs.latest_tag }}
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
    - name: Checkout
      uses: actions/checkout@main
      with:
        fetch-depth: 1
    - name: Install jq
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq jq
    - name: Check for new ImmortalWrt release
      id: check
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 获取最新的 ImmortalWrt tag（ImmortalWrt 没有 releases，只有 tags）
        if [ -n "${{ github.event.inputs.force_tag }}" ]; then
          LATEST_TAG="${{ github.event.inputs.force_tag }}"
        else
          # 从 GitHub API 获取所有 tags，找到最新的版本号格式的 tag
          # ImmortalWrt 的 tags 格式类似 v24.10.5 或 24.10.5
          echo "正在从 GitHub API 获取最新的 ImmortalWrt tag..." >&2
          
          # 获取所有 tags，过滤出符合版本号格式的，排序后取最新的
          LATEST_TAG=$(curl -s https://api.github.com/repos/immortalwrt/immortalwrt/tags | \
            jq -r '.[].name' | \
            grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | \
            sed 's/^v//' | \
            sort -V | \
            tail -n 1)
          
          # 如果获取不到，尝试从 refs/tags 获取
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            echo "从 tags API 获取失败，尝试从 refs/tags 获取..." >&2
            LATEST_TAG=$(curl -s https://api.github.com/repos/immortalwrt/immortalwrt/git/refs/tags | \
              jq -r '.[].ref' | \
              sed 's|refs/tags/||' | \
              grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | \
              sed 's/^v//' | \
              sort -V | \
              tail -n 1)
          fi
        fi
        
        # 验证版本号是否有效（不为 null 或空）
        if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
          echo "警告: GitHub API 返回的版本号无效，从下载页面获取..." >&2
          # 从下载页面获取最新可用版本
          LATEST_TAG=$(curl -s https://downloads.immortalwrt.org/releases/ | grep -oP 'href="\K[0-9]+\.[0-9]+\.[0-9]+(?=/")' | sort -V | tail -n 1)
          
          # 如果还是获取不到，使用默认版本
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            LATEST_TAG="24.10.0"
            echo "警告: 无法获取版本号，使用默认版本: $LATEST_TAG" >&2
          else
            echo "从下载页面获取到版本: $LATEST_TAG" >&2
          fi
        else
          echo "从 GitHub tags 获取到版本: $LATEST_TAG" >&2
        fi
        
        echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
        
        # 获取项目自己的 GitHub Releases 最新版本
        # 使用 GITHUB_TOKEN 获取项目的 releases
        CURRENT_REPO_VERSION=""
        echo "正在获取项目最新的 release 版本..." >&2
        
        # 从项目的 releases API 获取最新的 release tag
        CURRENT_REPO_VERSION=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
          "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
          jq -r '.tag_name // empty' 2>/dev/null || echo "")
        
        # 如果没有 release，尝试从 tags 获取（按版本号排序）
        if [ -z "$CURRENT_REPO_VERSION" ] || [ "$CURRENT_REPO_VERSION" = "null" ]; then
          echo "未找到 release，尝试从 tags 获取..." >&2
          CURRENT_REPO_VERSION=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
            "https://api.github.com/repos/${{ github.repository }}/tags" | \
            jq -r '.[].name' 2>/dev/null | \
            grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | \
            sed 's/^v//' | \
            sort -V | \
            tail -n 1 || echo "")
        fi
        
        # 清理版本号（移除 'v' 前缀）
        if [ -n "$CURRENT_REPO_VERSION" ]; then
          CURRENT_REPO_VERSION="${CURRENT_REPO_VERSION#v}"
        fi
        
        echo "上游 ImmortalWrt 最新版本: ${LATEST_TAG}"
        echo "项目当前 release 版本: ${CURRENT_REPO_VERSION:-无}"
        
        # 判断是否需要构建
        SHOULD_BUILD="false"
        # 如果是手动触发或者有强制 tag，总是构建
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ -n "${{ github.event.inputs.force_tag }}" ]; then
          SHOULD_BUILD="true"
          echo "手动触发或强制 tag，将进行构建"
        # 如果是 push 或 watch 事件，总是构建
        elif [ "${{ github.event_name }}" = "push" ] || [ "${{ github.event_name }}" = "watch" ]; then
          SHOULD_BUILD="true"
          echo "Push 或 watch 事件，将进行构建"
        # 如果是定时任务，对比版本号
        elif [ "${{ github.event_name }}" = "schedule" ]; then
          if [ -z "$CURRENT_REPO_VERSION" ]; then
            # 项目还没有 release，需要构建
            SHOULD_BUILD="true"
            echo "项目尚未有 release，将进行构建"
          elif [ "${LATEST_TAG}" != "${CURRENT_REPO_VERSION}" ]; then
            # 版本不同，需要构建
            SHOULD_BUILD="true"
            echo "发现新版本 (项目: ${CURRENT_REPO_VERSION} -> 上游: ${LATEST_TAG})，将进行构建"
          else
            # 版本相同，跳过构建
            SHOULD_BUILD="false"
            echo "版本已是最新 (${LATEST_TAG})，跳过构建"
          fi
        else
          SHOULD_BUILD="true"
          echo "未知事件类型，将进行构建"
        fi
        
        echo "should_build=${SHOULD_BUILD}" >> $GITHUB_OUTPUT

  build:
    needs: check-release
    runs-on: ubuntu-24.04
    if: |
      (github.event.repository.owner.id == github.event.sender.id || github.event_name == 'schedule') &&
      needs.check-release.outputs.should_build == 'true'

    steps:
    - name: Show system
      run: |
        echo -e "Total CPU cores\t: $(nproc)"
        cat /proc/cpuinfo | grep 'model name'
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 1024
        temp-reserve-mb: 512
        root-reserve-mb: 4608
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
    - name: Checkout
      uses: actions/checkout@main
    - name: Set ImmortalWrt tag
      run: |
        echo "IMMORTALWRT_TAG=${{ needs.check-release.outputs.latest_tag }}" >> $GITHUB_ENV
        echo "Building with ImmortalWrt tag: ${{ needs.check-release.outputs.latest_tag }}"
    - name: Install dependencies
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -y -qq install curl tar zstd xz-utils file git make
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo -E git config --global user.name 'GitHub Actions' && git config --global user.email 'noreply@github.com'
        sudo -E git config --global core.abbrev auto
        # 验证工具安装
        which zstd unzstd file tar curl
        df -h
    - name: Set tag_name for release
      run: |
        echo "tag_name=${{ needs.check-release.outputs.latest_tag }}" >>$GITHUB_ENV
    - name: Build with ImageBuilder
      env:
        IMMORTALWRT_TAG: ${{ needs.check-release.outputs.latest_tag }}
      run: |
        bash ./scripts/build-image.sh
    - name: Print Disk Space After
      run: df -h
    - name: Organize files
      id: organize
      run: |
        rm -rf ./artifact/
        mkdir -p ./artifact/
        if [ -d output ] && [ "$(ls -A output 2>/dev/null)" ]; then
          mv output/* ./artifact/ 2>/dev/null || true
        fi
        cd ./artifact/
        ls -Ahl
    - name: Upload artifact
      uses: actions/upload-artifact@main
      with:
        name: ImmortalWrt_${{ env.tag_name }}_ImageBuilder
        path: ./artifact/

    - name: Create release
      id: create_release
      uses: ncipollo/release-action@v1.14.0
      with:
        name: ${{ env.tag_name }}
        allowUpdates: true
        tag: ${{ env.tag_name }}
        replacesArtifacts: true
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ./artifact/*
